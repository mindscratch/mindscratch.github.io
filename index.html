<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">
<head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">

  
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title> craig wickesser &middot; craig wickesser </title>

  
  <link rel="stylesheet" href="http://craigwickesser.com/css/poole.css">
  <link rel="stylesheet" href="http://craigwickesser.com/css/syntax.css">
  <link rel="stylesheet" href="http://craigwickesser.com/css/hyde.css">
  <link rel="stylesheet" href="http://fonts.googleapis.com/css?family=PT+Sans:400,400italic,700|Abril+Fatface">

  
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/apple-touch-icon-144-precomposed.png">
  <link rel="shortcut icon" href="/favicon.ico">

  
  <link href="http://craigwickesser.com/index.xml/" rel="alternate" type="application/rss+xml" title="craig wickesser" />
</head>

<body>

<div class="sidebar">
  <div class="container sidebar-sticky">
    <div class="sidebar-about">
      <h1 class="foo">craig wickesser</h1>
      <p class="lead">
      An elegant open source and mobile first theme for <a href="http://hugo.spf13.com">hugo</a> made by <a href="http://twitter.com/mdo">@mdo</a>. Originally made for Jekyll.
      </p>
    </div>

    <ul class="sidebar-nav">
      <li><a href="/">Home</a> </li>
      
        <li><a href="http://craigwickesser.com/2015/01/golang-http-to-many-open-files/"> Go HTTP: Too Many Open Files </a></li>
      
        <li><a href="http://craigwickesser.com/2015/02/golang-cmd-with-custom-environment/"> Go: command with custom environment </a></li>
      
        <li><a href="http://craigwickesser.com/about/"> about </a></li>
      
        <li><a href="http://craigwickesser.com/subscribe/"> subscribe </a></li>
      
    </ul>

    <p>&copy; 2015. All rights reserved. </p>
  </div>
</div>


    <div class="content container">
<div class="posts">

      
  <div class="post">
    <h1 class="post-title">
      <a href="http://craigwickesser.com/2015/02/golang-cmd-with-custom-environment/">
        Go: command with custom environment
      </a>
    </h1>

    <span class="post-date">Tue, Feb 24, 2015</span>

    <p>test</p>

  </div>
  
  <div class="post">
    <h1 class="post-title">
      <a href="http://craigwickesser.com/2015/01/mindscratch-newsletter-1/">
        Mindscratch Newsletter 1
      </a>
    </h1>

    <span class="post-date">Wed, Jan 21, 2015</span>

    <p>On a regular basis, hopefully once per week, I&rsquo;ll be posting links to
content related to distributed systems, programming and devops. If you&rsquo;d prefer
to access this content via email, then <a href="/subscribe">subscribe</a>.</p>

<p><a href="http://www.meetup.com/Apache-Mesos-NYC-Meetup/events/219073804/">http://www.meetup.com/Apache-Mesos-NYC-Meetup/events/219073804/</a>
  - interesting b/c of  mention of running Accumulo on Mesos</p>

<p><a href="http://www.slideshare.net/ColleenLee1/iguaz-a-longrunning-job-scheduler-using-docker-and-mesos">http://www.slideshare.net/ColleenLee1/iguaz-a-longrunning-job-scheduler-using-docker-and-mesos</a>
  - job scheduler from corsera</p>

<p>Docker security
<a href="https://github.com/GDSSecurity/Docker-Secure-Deployment-Guidelines">https://github.com/GDSSecurity/Docker-Secure-Deployment-Guidelines</a>
<a href="https://www.gartner.com/doc/2956826">https://www.gartner.com/doc/2956826</a></p>

<p><a href="https://github.com/ExPHAT/twitter-sort">https://github.com/ExPHAT/twitter-sort</a></p>

<p><a href="http://am./chronos">http://am./chronos</a> &ndash;master zk://server1:2181/mesos &ndash;zk_hosts zk://server1:2181/mesos &ndash;http_port 8080bari.apache.org/</p>

<p><a href="http://jpetazzo.github.io/2015/01/13/docker-mount-dynamic-volumes/">http://jpetazzo.github.io/2015/01/13/docker-mount-dynamic-volumes/</a></p>

<p><a href="https://codeascraft.com/2015/01/14/introducing-statsd-jvm-profiler-a-jvm-profiler-for-hadoop/">https://codeascraft.com/2015/01/14/introducing-statsd-jvm-profiler-a-jvm-profiler-for-hadoop/</a></p>

<p>Go
Go Static Analysis Tools by Alan Donovan <a href="https://vimeo.com/116108566">https://vimeo.com/116108566</a>
Benchmarking Go <a href="https://vimeo.com/114975899">https://vimeo.com/114975899</a>
7 common mistakes in go and how to avoid them <a href="https://vimeo.com/115776445">https://vimeo.com/115776445</a>
cancellation, context and plumbing <a href="https://vimeo.com/115309491">https://vimeo.com/115309491</a></p>

<p>Io.js
<a href="https://www.youtube.com/watch?v=DqMFX91ToLw">https://www.youtube.com/watch?v=DqMFX91ToLw</a></p>

<p>Ecmascript 7 async &ndash; the evolution of javascript - <a href="https://www.youtube.com/watch?v=DqMFX91ToLw">https://www.youtube.com/watch?v=DqMFX91ToLw</a></p>

<p><a href="http://opensource.com/business/15/1/apache-spark-new-world-record">http://opensource.com/business/15/1/apache-spark-new-world-record</a></p>

<p><a href="http://events.linuxfoundation.org/events/vault/program/schedule?utm_source=lf&amp;utm_medium=email&amp;utm_campaign=vault15">http://events.linuxfoundation.org/events/vault/program/schedule?utm_source=lf&amp;utm_medium=email&amp;utm_campaign=vault15</a></p>

<p>onyx: <a href="https://www.youtube.com/watch?v=vG47Gui3hYE">https://www.youtube.com/watch?v=vG47Gui3hYE</a></p>

  </div>
  
  <div class="post">
    <h1 class="post-title">
      <a href="http://craigwickesser.com/about/">
        about
      </a>
    </h1>

    <span class="post-date">Wed, Jan 7, 2015</span>

    <p>I am Craig Wickesser and I write code for fun and for <a href="http://www.urbandictionary.com/define.php?term=Makin%27+Paper">makin&rsquo; paper</a>. I&rsquo;ve <a href="https://osrc.dfm.io/mindscratch/">contributed
code</a> to various open source projects using
a variety of programming languages.</p>

<p>I was an editor for <a href="http://www.jsmag.com/">jsmag</a> and <a href="http://groovymag.com/">GroovyMag</a>, but I have also written articles for <a href="http://www.infoq.com/author/Craig-Wickesser">InfoQ</a>, <a href="http://www.sitepoint.com/author/cwickesser/">SitePoint</a> and <a href="http://www.groovymag.com/authors">GroovyMag</a>.</p>

<p>As <a href="http://zedshaw.com/about/">Zed Shaw</a> says,</p>

<blockquote>
<p>I block comments on my writing because I believe you should go say what you think of my words on your own site instead of shitting all over mine.</p>
</blockquote>

  </div>
  
  <div class="post">
    <h1 class="post-title">
      <a href="http://craigwickesser.com/subscribe/">
        subscribe
      </a>
    </h1>

    <span class="post-date">Wed, Jan 7, 2015</span>

    <!-- Begin MailChimp Signup Form -->

<p><link href="//cdn-images.mailchimp.com/embedcode/classic-081711.css" rel="stylesheet" type="text/css">
<style type="text/css">
#mc_embed_signup{background:#fff; clear:left; font:14px Helvetica,Arial,sans-serif; }
/* Add your own MailChimp form style overrides in your site stylesheet or in this style block.
We recommend moving this block and the preceding CSS link to the HEAD of your HTML file. <em>/
</style>
<div id="mc_embed_signup">
<form action="//craigwickesser.us10.list-manage.com/subscribe/post?u=135d16fae140bd8a013bed501&amp;id=58b0dbb747" method="post" id="mc-embedded-subscribe-form" name="mc-embedded-subscribe-form" class="validate" target="_blank" novalidate>
<div id="mc_embed_signup_scroll">
<h2>Subscribe to the Mindscratch mailing list</h2>
<div class="indicates-required"><span class="asterisk"></em></span> indicates required</div>
<div class="mc-field-group">
<label for="mce-EMAIL">Email Address  <span class="asterisk">*</span>
</label>
<input type="email" value="" name="EMAIL" class="required email" id="mce-EMAIL">
</div>
<div class="mc-field-group">
<label for="mce-FNAME">First Name </label>
<input type="text" value="" name="FNAME" class="" id="mce-FNAME">
</div>
<div class="mc-field-group">
<label for="mce-MMERGE2">Website </label>
<input type="url" value="" name="MMERGE2" class=" url" id="mce-MMERGE2">
</div>
<div class="mc-field-group input-group">
<strong>Email Format </strong>
<ul><li><input type="radio" value="html" name="EMAILTYPE" id="mce-EMAILTYPE-0"><label for="mce-EMAILTYPE-0">html</label></li>
<li><input type="radio" value="text" name="EMAILTYPE" id="mce-EMAILTYPE-1"><label for="mce-EMAILTYPE-1">text</label></li>
</ul>
</div>
<p>Powered by <a href="http://eepurl.com/bbqCcP" title="MailChimp - email marketing made easy and fun">MailChimp</a></p>
<div id="mce-responses" class="clear">
<div class="response" id="mce-error-response" style="display:none"></div>
<div class="response" id="mce-success-response" style="display:none"></div>
</div>
<div style="position: absolute; left: -5000px;"><input type="text" name="b_135d16fae140bd8a013bed501_58b0dbb747" tabindex="-1" value=""></div>
<div class="clear"><input type="submit" value="Subscribe" name="subscribe" id="mc-embedded-subscribe" class="button"></div>
</div>
</form>
</div>
<script type='text/javascript' src='//s3.amazonaws.com/downloads.mailchimp.com/js/mc-validate.js'></script><script type='text/javascript'>(function($) {window.fnames = new Array(); window.ftypes = new Array();fnames[0]=&lsquo;EMAIL&rsquo;;ftypes[0]=&lsquo;email&rsquo;;fnames[1]=&lsquo;FNAME&rsquo;;ftypes[1]=&lsquo;text&rsquo;;fnames[2]=&lsquo;MMERGE2&rsquo;;ftypes[2]=&lsquo;url&rsquo;;}(jQuery));var $mcj = jQuery.noConflict(true);</script></p>

  </div>
  
  <div class="post">
    <h1 class="post-title">
      <a href="http://craigwickesser.com/2015/01/golang-http-to-many-open-files/">
        Go HTTP: Too Many Open Files
      </a>
    </h1>

    <span class="post-date">Wed, Jan 7, 2015</span>

    <p>I recently had a situation where an application I was working on in <a href="http://golang.org">Go</a> would
run into the &ldquo;too many open files&rdquo; error. After some debugging, I discovered
it wasn&rsquo;t closing HTTP connections being made to an HTTP server.</p>

<p><strong>Update</strong>: It turns out, I was testing against &ldquo;test&rdquo; server which wasn&rsquo;t
setting the <code>Connection: close</code> header, therefore neither the client or
server was requesting the connection to be closed. If the server had set the
<code>Connection</code> header, things would&rsquo;ve been fine.</p>

<p>The code looked like this:</p>

<pre><code class="language-go">  transport := &amp;http.Transport {
    Proxy: http.ProxyFromEnvironment,
    Dial: (&amp;net.Dialer{
      Timeout: 0,
      KeepAlive: 0
    }).Dial,
    TLSHandshakeTimeout: 10 * time.second
  }

  httpClient := &amp;http.Client{Transport: transport}

  function submitData(url string, fileReader io.Reader) error {
    req, reqErr := http.NewRequest(&quot;POST&quot;, url, fileReader)
    if reqErr != nil {
      return reqErr
    }
    req.Header.Set(&quot;Content-Type&quot;, &quot;application/octet-stream&quot;)

    resp, err := httpClient.Do(req)
    if err != nil {
      return err
    }
    defer resp.Body.Close()

    // read the body

    return nil
  }
</code></pre>

<p>The <code>submitData</code> function gets called over and over whenever new data needs to
be POSTed. Using <a href="http://en.wikipedia.org/wiki/Netstat">netstat</a> I noticed the
connections to the server were staying <code>ESTABLISHED</code> instead of being closed. I
set the &ldquo;timeout&rdquo; on the dialer to 0, because the POST should block until the
server is done and responds (which is an undetermined amount of time).</p>

<p>I know the server is responding, because the code that processes the response
was in fact getting data.</p>

<p>It turns out, HTTP/1.1 uses persistent connections by default:</p>

<blockquote>
<p>A significant difference between HTTP/1.1 and earlier versions of HTTP is that persistent connections are the default behavior of any HTTP connection.</p>
</blockquote>

<p><cite><a href="http://www.w3.org/Protocols/rfc2616/rfc2616-sec8.html">http://www.w3.org/Protocols/rfc2616/rfc2616-sec8.html</a></cite></p>

<p>The solution was to inform the server that the client wants to close the connection
after the transaction is complete. This can be done by setting the <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Connection">Connection</a>
header,</p>

<pre><code>req.Header.Set(&quot;Connection&quot;, &quot;close&quot;)
</code></pre>

<p>or by setting the <code>Close</code> property to <code>true</code> on the <a href="http://golang.org/pkg/net/http/#Request">http.Request</a>:</p>

<pre><code>req.Close = true
</code></pre>

<p>After doing that, the &ldquo;too many open files&rdquo; issue went away as the program was
no longer keeping HTTP connections open and thus not using up file descriptors.</p>

  </div>
  
  <div class="post">
    <h1 class="post-title">
      <a href="http://craigwickesser.com/2015/01/post-data-to-load-test-with-apachebench/">
        POST Data to Load Test with ApacheBench
      </a>
    </h1>

    <span class="post-date">Sat, Jan 3, 2015</span>

    <p><a href="http://httpd.apache.org/docs/2.2/programs/ab.html">ApacheBench</a> (also known as, ab) is,</p>

<blockquote>
<p>a tool for benchmarking your Apache Hypertext Transfer Protocol (HTTP) server</p>
</blockquote>

<p>Don&rsquo;t be fooled, you can use it to benchmark any server that supports HTTP. In
fact, it might be worth checking out <a href="https://github.com/rakyll/boom">boom</a> which
is written in <a href="http://golang.org">Go</a> which makes it easier to use across platforms,
and is simple to install (spoiler alert: it&rsquo;s just a binary).</p>

<p>Anyhow, in this post I&rsquo;ll demonstrate using ApacheBench (since I came across it first).</p>

<p>If you look at the documentation for <code>ab</code> you&rsquo;ll see there a bunch of options.
The focus of this post is the <code>-p POST-file</code> option which lets you POST a
<code>File containing data to POST</code>.</p>

<p>Sounded simple, so I thought I&rsquo;d give it a shot. I was trying to benchmark a form
submission. I thought maybe I could use <code>-p my-awesome-data.tgz</code>, but it
wasn&rsquo;t quite that simple.</p>

<p>After some googling, I found that what I needed to do was submit a file that
looked like a form based file upload. Turns out <a href="http://www.faqs.org/rfcs/rfc1867.html">RFC1867</a> was the ticket.
Here&rsquo;s an example, check out the RFC for more details.</p>

<pre><code>--1234567890
Content-Disposition: form-data; filename=&quot;my-awesome-data.tgz&quot;
Content-Type: application/octet-stream
Content-Transfer-Encoding: binary

&lt;base64 data&gt;
--1234567890
</code></pre>

<p>The boundary, <code>1234567890</code>, should be a value <strong>guaranteed</strong> not to appear in
the content of the request. The rest of the fields should be relatively simple
to understand. The <code>&lt;base64 data&gt;</code> portion must contain the base64 encoded
value of the file being uploaded.</p>

<p>Here&rsquo;s how you&rsquo;d run a benchmark that submits 100 requests, with 5 concurrent
clients using a file named <code>post.txt</code> (which looks like the example shown above)
to <code>http://server.com/api/v1/data</code></p>

<pre><code>ab -n 100 -c 5 -T 'multipart/form-data; boundary=1234567890' -p post.txt http://server.com/api/v1/data
</code></pre>

<p>I&rsquo;d like to try out boom, but the concepts are similar so I suspect it should be
just as easy.</p>

<p>Happy benchmarking!</p>

  </div>
  
  <div class="post">
    <h1 class="post-title">
      <a href="http://craigwickesser.com/2015/01/capture-stdout-in-go/">
        Capture STDOUT in Go
      </a>
    </h1>

    <span class="post-date">Fri, Jan 2, 2015</span>

    <p>Capturing output written to STDOUT (standard output) can be accomplished
with the following code.</p>

<pre><code>import (
  &quot;bytes&quot;
  &quot;io&quot;
  &quot;os&quot;
)

// not thread safe
func captureStdout(f func()) string {
  old := os.Stdout
  r, w, _ := os.Pipe()
  os.Stdout = w

  f()

  w.Close()
  os.Stdout = old

  var buf bytes.Buffer
  io.Copy(&amp;buf, r)
  return buf.String()
}
</code></pre>

<p>The code here is fairly straight forward. First, a reference to the <code>Writer</code>
that&rsquo;s assigned to <code>os.Stdout</code> is stashed for later. Next a <a href="http://golang.org/pkg/os/#Pipe">Pipe</a> is created,
which provides a connected pair of Files. The writer created by the Pipe is
assigned to <code>os.Stdout</code>. Perhaps you can see where this is going.</p>

<p>Next, we invoke the function provided to <code>captureStdout</code>. The writer is closed
and <code>os.Stdout</code> gets the original <code>Writer</code> assigned back to it.</p>

<p>The final steps are to copy the data from the reader, created from the Pipe,
and return the string as the result.</p>

<p>You should note, this code is <strong>not thread safe</strong>. Why? Because of that
<em>global</em> reference, <code>os.Stdout</code>.</p>

<p>An example using it would look something like this:</p>

<pre><code>func doSomething() {
  fmt.Println(&quot;This goes to STDOUT&quot;)
}

func example() {

  // invoke doSomething and return whatever it writes to STDOUT
  message := captureStdout(doSomething)

}
</code></pre>

<p>The example shown is trivial. I had a use case where I had to execute an
executable on the system that wrote data to STDOUT which I needed to process.</p>

  </div>
  
  <div class="post">
    <h1 class="post-title">
      <a href="http://craigwickesser.com/2014/12/windows-8-thoughts/">
        Thoughts on Windows 8
      </a>
    </h1>

    <span class="post-date">Sun, Dec 28, 2014</span>

    <p>My son received a laptop, his first, for Christmas. It&rsquo;s an ASUS running Windows 8. To date, he&rsquo;s only used Apple laptops, iPad, iPhone Touch and Galaxy S3/<sup>4</sup>&frasl;<sub>5</sub> Android phones at home.</p>

<p>I helped setup the laptop and the first thing I noticed was the &ldquo;app&rdquo; centric user interface. I noticed he seemed to be able to navigate around rather easily and wasn&rsquo;t getting lost. The &ldquo;app&rdquo; centric focus of the operating system is compelling and I believe a win for Microsoft in terms of aligning with the younger generation.</p>

<p>The first issue I ran into was when my son wanted to install the YouTube client.  I was able to find it in the Store, thanks to it being near the top of the &ldquo;Top Free&rdquo; apps. I was surprised not to see a &ldquo;search&rdquo; option, but perhaps I just didn&rsquo;t see it. The Store said that Windows 8.1 was required to install the YouTube client.</p>

<p>Luckily, the Store had Windows 8.1 as a featured item to install, so I clicked the button to install it. I was then prompted with a message stating updates needed to be installed first. I began the install for those which took a little over an hour and required a restart.</p>

<p>Once the laptop booted up, I went back to the store to install Windows 8.1. Again, it took a while and required a restart. After the laptop booted up with Windows 8.1 freshly installed I went back to the Store. This time I noticed a search box, which I used to find the YouTube client, since the &ldquo;Top Free&rdquo; apps list was no longer an option.</p>

<p>Upon trying to install the YouTube client it stated that it required a parents permission (since my son is younger than 13). I clicked the &ldquo;Fix It&rdquo; button, logged into my Microsoft Live account (which I forgot I had). After logging in, I was just dropped into the account home, no directions on where to go to approve installing the YouTube client app. I went back to try installing the YouTube client and again it said, I could &ldquo;Fix It&rdquo; (the parent permission issue). I clicked the button and again it just took me to the Microsoft Live account home page.</p>

<p>After trying several variations of the steps I&rsquo;ve already described, I decided I&rsquo;d change my sons account to make his birthday such that he was at least 13 years old. After I figured out how to do that, I was required to put in credit card information so Microsoft could verify I (my son in this case) was an adult. I submitted the information, and Microsoft was happy that the credit card I submitted verified someone elses age (since the card has my name, not my sons).</p>

<p>Finally, I was able to install the YouTube client app.</p>

<p>This is where Windows 8 went wrong. Certain aspects are just overly complicated and difficult to follow, especially for children. In concrast, the <a href="www.amazon.com/kids-edition-tablet">Amazon Fire Kids</a> made it stupid simple to setup, add a &ldquo;childs&rdquo; account and let them begin playing with it (including add apps). Certainly the Windows 8 laptop and the Amazon tablet are different in many ways, but I think the comparison is reasonable to demonstrate how Windows 8 got things wrong and how something like the Amazon Fire kids tablet got it right.</p>

<p><a href="https://twitter.com/hashtag/windows8">#windows8</a> <a href="https://twitter.com/hashtag/amazon">#amazon</a></p>

  </div>
  
  <div class="post">
    <h1 class="post-title">
      <a href="http://craigwickesser.com/2014/12/starting-a-new-go-project/">
        Starting a new Go project
      </a>
    </h1>

    <span class="post-date">Tue, Dec 9, 2014</span>

    

<p>I have the need for a program that can monitor Kubernetes* for services* and update an HAProxy* configuration file when changes occur. Sounds rather simple, however, there&rsquo;s a slight twist. I don&rsquo;t want to simply add entries to HAProxy for each service created in Kubernetes (it also wouldn&rsquo;t work as multiple services in Kubernetes could have the same port, since each service has its own IP address).</p>

<p>Instead I need a way to define a set of rules, perhaps as simple as a template, that will be used to update the HAProxy configuration file intelligently.</p>

<p>The template spec:</p>

<pre><code class="language-go">type ServiceEntry struct {
    Name string `json:&quot;name,omitempty&quot;`
    Port int `json:&quot;port,omitempty&quot;`
    Uri string `json:&quot;uri,omitempty&quot;`
}

type ServiceEntries []ServiceEntry {}
</code></pre>

<pre><code>services:
    # accessible as http://&lt;proxy ip&gt;:9200
    # the name of the service to monitor
    - name: elasticsearch
    # the port on the proxy for the service
      port: 9200
    # the uri on the proxy for the service
      uri: /
    # accessible as http://&lt;proxy ip&gt;/kibana
    - name: kibana
      port: 80
      uri: /kibana
</code></pre>

<p>To be continued&hellip;</p>

<h3 id="toc_0">Resources</h3>

<ul>
<li><a href="https://github.com/GoogleCloudPlatform/kubernetes/">Kubernetes</a></li>
<li><a href="https://github.com/GoogleCloudPlatform/kubernetes/blob/master/docs/services.md">Kubernetes services</a></li>
<li><a href="http://www.haproxy.org/">HAProxy</a></li>
<li><a href="https://code.google.com/p/go-wiki/wiki/GithubCodeLayout">GithubCodeLayout</a></li>
</ul>

  </div>
  
</div>
</div>

  </body>
</html>
